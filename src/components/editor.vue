<template>
  <div class="editor">
    <textarea ref="textarea" class="editor"> </textarea>
  </div>
</template>

<script>
import CodeMirror from "codemirror";
import emmet from "@emmetio/codemirror-plugin";
import "codemirror/lib/codemirror.css";
import "codemirror/theme/lucario.css";
import "codemirror/addon/selection/active-line";
import "codemirror/addon/edit/matchbrackets";
import "codemirror/mode/vue/vue";
import { debounce } from "throttle-debounce";
import isAbsouteUrl from "is-absolute-url";
import { downloadURL } from "@/utils/store";

emmet(CodeMirror);
const defaultValue = `<template>
  <div>
    <h2>Hello {{ msg }}</h2>
    <h3>Demo</h3>
    <ul>
      <li v-for="url in urls">
        <a target="_blank" :href="url">{{ url }}</a>
      </li>
    </ul>
  </div>
</template>

<script>
export default {
  data: () => ({
    msg: 'Vuep.run',

    urls: [
      'https://vuep.run/QingWei-Li/vue-trend/docs/home.vue',
      'https://vuep.run/QingWei-Li/vuep.run/examples/element-ui.vue?pkg=element-ui&css=element-ui/lib/theme-chalk/index.css',
      'https://vuep.run/vuetifyjs/vuetifyjs.com/blob/dev/examples/ripples/navigationDrawers.vue?pkg=vuetify&css=vuetify/dist/vuetify.min.css'
    ]
  })
}
<\/script>

<style lang='less' scoped>
@color:#2c3e50;
div {
  color: @color;
  font-family: Arial, sans-serif;
}

a {
  color: #42b983;
}
</style>`;

export default {
  props: {
    autoRender: Boolean
  },
  data: () => ({
    code: "",
    editor: null
  }),

  methods: {
    initCodeEdit() {
      this.editor = CodeMirror.fromTextArea(this.$refs.textarea, {
        mode: "vue",
        theme: "lucario",
        value: `<template></template>`,
        lineNumbers: true,
        tabSize: 2,
        autofocus: true,
        line: true,
        styleActiveLine: true,
        matchBrackets: true,
        extraKeys: {
          Tab: "emmetExpandAbbreviation",
          Enter: "emmetInsertLineBreak"
        }
      });
      if (this.autoRender) {
        this.editor.on(
          "change",
          debounce(500, () => {
            this.$emit("change", this.editor.getValue());
          })
        );
      }
    },
    async getFileContent(filename) {
      this.$toasted.show("Loading file...");

      let url;
      if (/^\w+$/.test(filename)) {
        url = downloadURL(filename);
      } else if (isAbsouteUrl(filename)) {
        url = filename;
      } else if (/^[\w-]+\.\w+/.test(filename)) {
        url = "//" + filename;
      } else {
        // convert url to github raw url
        const repo = filename.match(/^([^/]+\/[^/]+)(\/blob\/([\w-]+))?(\S+)$/);
        url = `//raw.githubusercontent.com/${repo[1]}/${repo[3] || "master"}${
          repo[4]
        }`;
      }

      if (/github\.com\//.test(url)) {
        url = url
          .replace(/github\.com\//, "raw.githubusercontent.com/")
          .replace(/\/blob\//, "/");
      }

      try {
        const result = await fetch(url);

        this.$toasted.clear();

        return await result.text();
      } catch (e) {
        this.$toasted.clear();
        this.$toasted.show("File not found", {
          type: "error",
          duration: 2000
        });
        return null;
      }
    },
    setCode(code) {
      if (this.editor) {
        this.editor.setValue(code);
      }
    },
    emitChange() {
      if (this.editor) {
        this.$emit("change", this.editor.getValue());
      }
    }
  },

  async mounted() {
    this.initCodeEdit();

    let value;
    if (location.pathname !== "/") {
      value = await this.getFileContent(location.pathname.slice(1));
    }
    value = value || defaultValue;
    this.setCode(value);
    this.emitChange();
  }
};
</script>

<style lang="stylus" scoped>
.editor >>> .CodeMirror
  border 1px solid black
  height 100%
  line-height 1.2rem
</style>
